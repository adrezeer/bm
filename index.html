<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تطبيق تسميع الأسئلة والإجابات</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--soft:#111827;--success:#10b981;--danger:#ef4444}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif;background:linear-gradient(180deg,#021226 0%,#041226 100%);color:#e6eef6}
    .container{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    h1{margin:0;font-size:22px;font-weight:700}
    p.lead{margin:0;color:var(--muted);font-size:14px}

    .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-top:18px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
    .form-row{display:flex;gap:8px;align-items:center}
    input,textarea,button,select{font-size:15px}
    input[type="text"],input[type="number"],textarea,select{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:inherit;transition:all 0.2s}
    input[type="text"]:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.04)}
    textarea{min-height:62px;resize:vertical}
    .btn{background:var(--accent);border:none;color:#000;padding:10px 16px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-weight:600}
    .btn:hover:not(:disabled){opacity:0.9;transform:translateY(-1px);box-shadow:0 4px 12px rgba(6,182,212,0.3)}
    .btn:active:not(:disabled){transform:translateY(0)}
    .btn:disabled{opacity:0.4;cursor:not-allowed}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}
    .btn.secondary:hover:not(:disabled){background:rgba(255,255,255,0.05);color:#fff}
    .btn.success{background:var(--success);color:#000}
    .btn.danger{background:var(--danger);color:#fff}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    ul.list{list-style:none;padding:0;margin:10px 0 0}
    li.item{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);margin-bottom:8px;display:flex;justify-content:space-between;gap:10px;transition:all 0.2s}
    li.item:hover{background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.1)}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .small{font-size:13px;color:var(--muted)}
    .feedback{margin-top:10px;padding:10px 12px;border-radius:8px;font-size:14px}
    .ok{background:rgba(6,182,212,0.12);color:#a7f0ff;border-left:3px solid #06b6d4}
    .bad{background:rgba(255,60,60,0.08);color:#ffdede;border-left:3px solid #ef4444}
    .warning{background:rgba(251,191,36,0.12);color:#fef3c7;border-left:3px solid #f59e0b}
    .success{background:rgba(16,185,129,0.12);color:#a7f3d0;border-left:3px solid #10b981}
    footer{margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05);color:var(--muted);font-size:13px}
    .voice-method{padding:10px;border-radius:6px;background:rgba(6,182,212,0.1);margin-top:8px;font-size:13px}
    .progress-bar{width:100%;height:6px;background:rgba(255,255,255,0.05);border-radius:10px;overflow:hidden;margin-top:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#06b6d4,#10b981);transition:width 0.3s ease;border-radius:10px}
    .stage-indicator{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .stage-dot{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.1);transition:all 0.3s}
    .stage-dot.active{background:var(--accent);box-shadow:0 0 8px var(--accent)}
    .stage-dot.completed{background:var(--success)}
    .stats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .stat-box{flex:1;min-width:150px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.05)}
    .stat-value{font-size:24px;font-weight:700;color:var(--accent)}
    .stat-label{font-size:12px;color:var(--muted);margin-top:4px}
    @media (max-width:640px){.form-row{flex-direction:column}.stats{flex-direction:column}}
    
    /* Animations */
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .slide-in{animation:slideIn 0.3s ease}
  </style>
</head>
<body dir="rtl">
  <div class="container">
    <header>
      <div>
        <h1>🎓 تطبيق تسميع الأسئلة والإجابات المتقدم</h1>
        <p class="lead">أضف أسئلة وإجابات ثم ابدأ رحلة الحفظ بنظام مراحل تفاعلي مع نطق عربي احترافي</p>
      </div>
    </header>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px;display:flex;align-items:center;gap:8px">
        ➕ أضف سؤال وإجابة
      </h2>
      <div class="form-row" style="margin-bottom:8px">
        <input type="text" id="questionInput" placeholder="أكتب السؤال هنا..." autocomplete="off" />
        <input type="text" id="answerInput" placeholder="أكتب الإجابة هنا..." autocomplete="off" />
        <button class="btn" id="addBtn">إضافة</button>
      </div>
      <div class="small">💡 يمكنك إضافة عدد غير محدود من الأسئلة. البيانات محفوظة خلال الجلسة.</div>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">🔧 الإعدادات</h2>
      
      <div style="margin-bottom:14px">
        <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">طريقة النطق:</label>
        <select id="voiceMethod" style="width:100%;max-width:400px;padding:10px">
          <option value="google" selected>🌐 Google TTS (موصى به - نطق عربي ممتاز)</option>
          <option value="browser">💻 متصفح (Web Speech API)</option>
        </select>
      </div>
      
      <div style="margin-bottom:14px">
        <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">سرعة النطق:</label>
        <div style="display:flex;align-items:center;gap:12px">
          <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="1.0" style="flex:1;max-width:350px">
          <span id="rateValue" style="font-size:15px;color:var(--accent);font-weight:600;min-width:50px">1.0x</span>
        </div>
      </div>
      
      <div style="margin-bottom:14px">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s" id="autoLabel">
          <input type="checkbox" id="autoProgress" checked style="width:18px;height:18px;cursor:pointer">
          <span>🔄 الانتقال التلقائي للمراحل (ينتقل تلقائياً بعد انتهاء كل مرحلة)</span>
        </label>
      </div>
      
      <div style="margin-bottom:14px">
        <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">مدة التوقف بين الأسئلة (ثانية):</label>
        <div style="display:flex;align-items:center;gap:12px">
          <input type="range" id="delayTime" min="0.3" max="2" step="0.1" value="0.5" style="flex:1;max-width:350px">
          <span id="delayValue" style="font-size:15px;color:var(--accent);font-weight:600;min-width:50px">0.5s</span>
        </div>
      </div>
      
      <div class="controls">
        <button class="btn secondary" id="testVoice">🔊 اختبر الصوت</button>
        <button class="btn success" id="startAll">▶️ ابدأ جميع المراحل</button>
      </div>
      <div id="voiceInfo" class="voice-method"></div>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">📝 قائمة الأسئلة (<span id="qaCount">0</span>)</h2>
      <div class="small" style="margin-bottom:12px">يمكنك حذف أو تشغيل أي سؤال بشكل فردي</div>
      <ul class="list" id="qaList"></ul>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">🎯 المراحل التعليمية</h2>
      
      <div class="stage-indicator">
        <div class="stage-dot" data-stage="1" title="المرحلة 1"></div>
        <div class="stage-dot" data-stage="2" title="المرحلة 2"></div>
        <div class="stage-dot" data-stage="3" title="المرحلة 3"></div>
        <div class="stage-dot" data-stage="4" title="المرحلة 4"></div>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      
      <div class="controls" style="margin-top:16px">
        <button class="btn" id="stage1">1️⃣ حفظ (س←ج ×3)</button>
        <button class="btn" id="stage2">2️⃣ اختبار صوتي 🎤</button>
        <button class="btn" id="stage3">3️⃣ استماع كامل 🎧</button>
        <button class="btn" id="stage4">4️⃣ تسميع نهائي 📝</button>
        <button class="btn danger" id="stopAll">⏹️ إيقاف</button>
      </div>

      <div id="status" class="small" style="margin-top:12px;color:var(--muted);font-weight:600">📊 الحالة: جاهز للبدء</div>
      <div id="feedback" class="feedback" style="display:none"></div>
      
      <div class="stats" id="statsContainer" style="display:none">
        <div class="stat-box">
          <div class="stat-value" id="correctCount">0</div>
          <div class="stat-label">إجابات صحيحة</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">إجمالي الأسئلة</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="percentageCount">0%</div>
          <div class="stat-label">نسبة النجاح</div>
        </div>
      </div>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">⚙️ إدارة</h2>
      <div class="controls">
        <button class="btn secondary" id="clearStorage">🗑️ مسح كل الأسئلة</button>
        <button class="btn secondary" id="exportData">📥 تصدير البيانات</button>
        <button class="btn secondary" id="importData">📤 استيراد البيانات</button>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </section>

    <footer>
      <div class="small">
        <strong>💡 نصائح:</strong> للحصول على أفضل تجربة، استخدم سماعات الرأس وتأكد من اتصالك بالإنترنت.
        التطبيق يستخدم Google TTS للنطق العربي الاحترافي.
      </div>
      <div class="small" style="margin-top:8px">
        تم التطوير بواسطة Claude AI | يعمل في المتصفح بدون خادم
      </div>
    </footer>
  </div>

  <script>
    // ========== المتغيرات العامة ==========
    let qa = [];
    let isProcessing = false;
    let shouldStop = false;
    let currentVoiceMethod = 'google';
    let speechRate = 1.0;
    let autoProgress = true;
    let delayTime = 500;
    let currentStage = 0;
    let completedStages = new Set();

    // ========== العناصر ==========
    const qInput = document.getElementById('questionInput');
    const aInput = document.getElementById('answerInput');
    const addBtn = document.getElementById('addBtn');
    const qaList = document.getElementById('qaList');
    const qaCount = document.getElementById('qaCount');
    const status = document.getElementById('status');
    const feedback = document.getElementById('feedback');
    const voiceInfo = document.getElementById('voiceInfo');
    const voiceMethodSelect = document.getElementById('voiceMethod');
    const speechRateSlider = document.getElementById('speechRate');
    const rateValue = document.getElementById('rateValue');
    const autoProgressCheck = document.getElementById('autoProgress');
    const delayTimeSlider = document.getElementById('delayTime');
    const delayValue = document.getElementById('delayValue');
    const progressFill = document.getElementById('progressFill');
    const statsContainer = document.getElementById('statsContainer');
    const correctCountEl = document.getElementById('correctCount');
    const totalCountEl = document.getElementById('totalCount');
    const percentageCountEl = document.getElementById('percentageCount');

    // ========== الإعدادات ==========
    voiceMethodSelect.onchange = ()=>{
      currentVoiceMethod = voiceMethodSelect.value;
      updateVoiceInfo();
    };

    speechRateSlider.oninput = ()=>{
      speechRate = parseFloat(speechRateSlider.value);
      rateValue.textContent = speechRate.toFixed(1) + 'x';
    };

    autoProgressCheck.onchange = ()=>{
      autoProgress = autoProgressCheck.checked;
    };

    delayTimeSlider.oninput = ()=>{
      delayTime = parseFloat(delayTimeSlider.value) * 1000;
      delayValue.textContent = (delayTime/1000).toFixed(1) + 's';
    };

    function updateVoiceInfo(){
      if(currentVoiceMethod === 'google'){
        voiceInfo.innerHTML = '✅ يستخدم Google TTS - نطق عربي طبيعي وواضح';
        voiceInfo.style.background = 'rgba(6,182,212,0.1)';
        voiceInfo.style.color = '#a7f0ff';
      } else {
        voiceInfo.innerHTML = '⚠️ يستخدم أصوات المتصفح - قد يكون النطق أقل وضوحاً';
        voiceInfo.style.background = 'rgba(251,191,36,0.1)';
        voiceInfo.style.color = '#fef3c7';
      }
    }

    updateVoiceInfo();

    // ========== وظائف مساعدة ==========
    function normalizeText(s){
      if(!s) return '';
      s = s.toString();
      s = s.replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'');
      s = s.replace(/[\u2000-\u206F\u2E00-\u2E7F\`\~\!\@\#\$\%\^\&\*\(\)\-_\+=\[\]\\\{\}\|\;\:\"\'\<\>,\.\?\/]/g,'');
      s = s.replace(/\s+/g,' ').trim().toLowerCase();
      return s;
    }

    function escapeHtml(s){ 
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); 
    }

    function delay(ms){ 
      return new Promise(r=>setTimeout(r,ms)); 
    }

    function disableButtons(disabled){
      document.querySelectorAll('.btn').forEach(btn => {
        if(btn.id !== 'stopAll'){
          btn.disabled = disabled;
        }
      });
    }

    function updateProgress(percentage){
      progressFill.style.width = percentage + '%';
    }

    function updateStageIndicator(stage, isActive = false){
      document.querySelectorAll('.stage-dot').forEach(dot => {
        const dotStage = parseInt(dot.dataset.stage);
        dot.classList.remove('active');
        if(dotStage < stage){
          dot.classList.add('completed');
        } else if(dotStage === stage && isActive){
          dot.classList.add('active');
        } else if(dotStage > stage){
          dot.classList.remove('completed');
        }
      });
    }

    function showStats(correct, total){
      const percentage = total > 0 ? Math.round(correct/total*100) : 0;
      correctCountEl.textContent = correct;
      totalCountEl.textContent = total;
      percentageCountEl.textContent = percentage + '%';
      statsContainer.style.display = 'flex';
    }

    function hideStats(){
      statsContainer.style.display = 'none';
    }

    function showFeedback(msg, type='ok'){
      feedback.style.display = 'block';
      feedback.textContent = msg;
      feedback.className = 'feedback slide-in ' + type;
    }

    // ========== إدارة القائمة ==========
    function updateQACount(){
      qaCount.textContent = qa.length;
    }

    function renderList(){
      qaList.innerHTML = '';
      if(qa.length===0){
        qaList.innerHTML = '<li class="small">لا توجد أسئلة بعد. ابدأ بإضافة أول سؤال!</li>';
        updateQACount();
        return;
      }
      
      qa.forEach((item,idx)=>{
        const li = document.createElement('li'); 
        li.className='item';
        li.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:600;font-size:15px">${escapeHtml(item.q)}</div>
            <div class="meta">✅ الإجابة: ${escapeHtml(item.a)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start">
            <button class="btn secondary" data-idx="${idx}" style="padding:6px 12px;font-size:13px">🗑️ حذف</button>
            <button class="btn secondary" data-play="${idx}" style="padding:6px 12px;font-size:13px">🔊 تشغيل</button>
          </div>
        `;
        qaList.appendChild(li);
      });

      qaList.querySelectorAll('button[data-idx]').forEach(b=>{
        b.onclick = ()=>{ 
          const i = +b.dataset.idx;
          if(confirm('هل تريد حذف هذا السؤال؟')){
            qa.splice(i,1); 
            renderList();
            showFeedback('تم الحذف ✓','ok');
            setTimeout(()=>feedback.style.display='none', 2000);
          }
        }
      });
      
      qaList.querySelectorAll('button[data-play]').forEach(b=>{
        b.onclick = ()=>{ 
          const i = +b.dataset.play; 
          speakQA(qa[i].q, qa[i].a); 
        }
      });
      
      updateQACount();
    }

    addBtn.onclick = ()=>{
      const q = qInput.value.trim();
      const a = aInput.value.trim();
      if(!q || !a){ 
        showFeedback('⚠️ يجب كتابة السؤال والإجابة قبل الإضافة','warning'); 
        return; 
      }
      qa.push({q,a}); 
      renderList(); 
      qInput.value=''; 
      aInput.value=''; 
      qInput.focus(); 
      showFeedback('✅ تم إضافة السؤال بنجاح','success');
      setTimeout(()=>feedback.style.display='none', 2000);
    }

    // Enter للإضافة
    aInput.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter') addBtn.click();
    });

    document.getElementById('clearStorage').onclick = ()=>{
      if(!confirm('⚠️ هل أنت متأكد من حذف جميع الأسئلة؟ هذا الإجراء لا يمكن التراجع عنه.')) return; 
      qa=[]; 
      renderList(); 
      hideStats();
      completedStages.clear();
      updateStageIndicator(0);
      updateProgress(0);
      showFeedback('✅ تم حذف جميع الأسئلة','success');
    }

    // ========== تصدير واستيراد ==========
    document.getElementById('exportData').onclick = ()=>{
      if(qa.length === 0){
        showFeedback('⚠️ لا توجد أسئلة للتصدير','warning');
        return;
      }
      const dataStr = JSON.stringify(qa, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'اسئلة-وإجابات-' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showFeedback('✅ تم تصدير البيانات','success');
    };

    document.getElementById('importData').onclick = ()=>{
      document.getElementById('fileInput').click();
    };

    document.getElementById('fileInput').onchange = (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const imported = JSON.parse(ev.target.result);
          if(Array.isArray(imported)){
            qa = imported;
            renderList();
            showFeedback('✅ تم استيراد ' + qa.length + ' سؤال','success');
          } else {
            showFeedback('❌ ملف غير صالح','bad');
          }
        }catch(err){
          showFeedback('❌ خطأ في قراءة الملف','bad');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    };

    renderList();

    // ========== نظام النطق ==========
    function speakWithGoogle(text, rate = 1.0){
      return new Promise((resolve)=>{
        try{
          const audio = new Audio();
          const encodedText = encodeURIComponent(text);
          audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ar&client=tw-ob&q=${encodedText}`;
          audio.playbackRate = rate;
          
          audio.onended = ()=> resolve();
          audio.onerror = ()=> {
            console.error('خطأ في Google TTS');
            resolve();
          };
          
          audio.play().catch(e => {
            console.error('خطأ في تشغيل الصوت:', e);
            resolve();
          });
        } catch(e){
          console.error('خطأ:', e);
          resolve();
        }
      });
    }

    function speakWithBrowser(text, rate = 1.0){
      return new Promise((resolve)=>{
        const synth = window.speechSynthesis;
        if(!synth){
          resolve();
          return;
        }

        synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        
        const voices = synth.getVoices();
        const arabicVoice = voices.find(v => 
          v.lang.startsWith('ar') || v.name.includes('Arabic')
        );
        
        if(arabicVoice){
          utter.voice = arabicVoice;
          utter.lang = arabicVoice.lang;
        } else {
          utter.lang = 'ar-SA';
        }
        
        utter.rate = rate * 0.85;
        utter.pitch = 1.0;
        utter.volume = 1.0;
        
        utter.onend = ()=>resolve();
        utter.onerror = ()=>resolve();
        
        synth.speak(utter);
      });
    }

    function speak(text, rate = null){
      if(shouldStop) return Promise.resolve();
      const actualRate = rate !== null ? rate : speechRate;
      
      if(currentVoiceMethod === 'google'){
        return speakWithGoogle(text, actualRate);
      } else {
        return speakWithBrowser(text, actualRate);
      }
    }

    async function speakQA(q,a){
      if(isProcessing) return;
      isProcessing = true;
      status.textContent = '🔊 تشغيل سؤال واحد...';
      await speak(q);
      await delay(delayTime);
      await speak(a);
      status.textContent = '📊 جاهز للبدء';
      isProcessing = false;
    }

    // ========== اختبار الصوت ==========
    document.getElementById('testVoice').onclick = async ()=>{
      if(isProcessing) return;
      showFeedback('🔊 جاري اختبار الصوت...','ok');
      await speak('مرحباً، هذا اختبار للصوت العربي. السرعة الحالية ' + speechRate.toFixed(1));
      showFeedback('✅ تم اختبار الصوت بنجاح','success');
      setTimeout(()=>feedback.style.display='none', 3000);
    };

    // ========== إيقاف ==========
    document.getElementById('stopAll').onclick = ()=>{
      shouldStop = true;
      isProcessing = false;
      disableButtons(false);
      status.textContent = '⏹️ تم الإيقاف';
      showFeedback('⏹️ تم إيقاف العملية','warning');
      if(window.speechSynthesis) window.speechSynthesis.cancel();
    };

    // ========== المراحل ==========
    
    // المرحلة 1: حفظ
    async function runStage1(){
      if(qa.length===0){ 
        showFeedback('⚠️ لا توجد أسئلة لتشغيل المرحلة 1','warning'); 
        return false; 
      }
      
      currentStage = 1;
      updateStageIndicator(1, true);
      status.textContent = '🎯 المرحلة 1 - الحفظ';
      showFeedback('🎯 المرحلة 1: سيتم نطق كل سؤال ثم إجابته 3 مرات','ok');
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        const {q,a} = qa[i];
        status.textContent = `🎯 المرحلة 1 - سؤال ${i+1} من ${qa.length}`;
        updateProgress(((i+1)/qa.length) * 25);
        
        for(let r=0; r<3 && !shouldStop; r++){
          await speak(q);
          await delay(delayTime * 0.6);
          await speak(a);
          await delay(delayTime * 0.8);
        }
      }
      
      if(shouldStop) return false;
      
      completedStages.add(1);
      updateStageIndicator(1);
      status.textContent = '✅ انتهت المرحلة 1';
      showFeedback('✅ انتهت المرحلة 1 - الحفظ بنجاح','success');
      return true;
    }

    document.getElementById('stage1').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      hideStats();
      
      await runStage1();
      
      isProcessing = false;
      disableButtons(false);
    };

    // المرحلة 2: اختبار صوتي
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    
    function recognizeOnce(lang='ar-SA'){
      return new Promise((res,rej)=>{
        if(!SpeechRecognition){ 
          rej(new Error('متصفحك لا يدعم SpeechRecognition')); 
          return; 
        }
        
        const rec = new SpeechRecognition();
        rec.lang = lang; 
        rec.interimResults = false; 
        rec.maxAlternatives = 1;
        
        rec.onresult = (ev)=>{ 
          const txt = ev.results[0][0].transcript; 
          res(txt); 
        };
        
        rec.onerror = (e)=>rej(e);
        rec.onend = ()=>{};
        
        try{ 
          rec.start(); 
        }catch(e){ 
          rej(e); 
        }
      });
    }

    async function runStage2(){
      if(qa.length===0){ 
        showFeedback('⚠️ لا توجد أسئلة للاختبار','warning'); 
        return false; 
      }
      if(!SpeechRecognition){ 
        showFeedback('❌ ميزة التعرف على الصوت غير متاحة. استخدم Chrome/Edge.','bad'); 
        return false; 
      }
      
      currentStage = 2;
      updateStageIndicator(2, true);
      status.textContent = '🎤 المرحلة 2 - اختبار صوتي';
      let correct = 0;
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        const {q,a} = qa[i];
        updateProgress(25 + ((i+1)/qa.length) * 25);
        
        await speak(q);
        await delay(delayTime * 0.5);
        
        status.textContent = `🎤 سؤال ${i+1} من ${qa.length} - اجب الآن`;
        showFeedback(`🎤 السؤال ${i+1}: استمع وأجِب بصوت واضح`,'ok');
        
        try{
          const userTxt = await recognizeOnce('ar-SA');
          const userNorm = normalizeText(userTxt);
          const answerNorm = normalizeText(a);
          const isCorrect = (userNorm === answerNorm);
          
          if(isCorrect){ 
            correct++; 
            showFeedback(`✅ (${i+1}) إجابة صحيحة: "${userTxt}"`,'success'); 
            await speak('ممتاز، إجابة صحيحة'); 
          } else { 
            showFeedback(`❌ (${i+1}) خاطئ - قلت: "${userTxt}" | الصواب: "${a}"`,'bad'); 
            await speak('إجابة خاطئة');
            await delay(delayTime * 0.4);
            await speak('الإجابة الصحيحة هي');
            await delay(delayTime * 0.3);
            await speak(a); 
          }
          await delay(delayTime);
        }catch(e){ 
          showFeedback(`⚠️ (${i+1}) لم يتم سماع إجابتك - تأكد من الميكروفون`,'warning'); 
          await delay(delayTime * 2);
        }
      }
      
      if(shouldStop) return false;
      
      showStats(correct, qa.length);
      completedStages.add(2);
      updateStageIndicator(2);
      
      const percentage = Math.round(correct/qa.length*100);
      status.textContent = `✅ انتهت المرحلة 2 - النتيجة: ${correct}/${qa.length} (${percentage}%)`;
      showFeedback(`✅ انتهت المرحلة 2! النتيجة: ${correct} من ${qa.length} (${percentage}%)`, 
        percentage >= 80 ? 'success' : 'warning');
      return true;
    }

    document.getElementById('stage2').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      
      await runStage2();
      
      isProcessing = false;
      disableButtons(false);
    };

    // المرحلة 3: استماع كامل
    async function runStage3(){
      if(qa.length===0){ 
        showFeedback('⚠️ لا توجد أسئلة للاستماع','warning'); 
        return false; 
      }
      
      currentStage = 3;
      updateStageIndicator(3, true);
      status.textContent = '🎧 المرحلة 3 - استماع كامل';
      showFeedback('🎧 المرحلة 3: الاستماع لجميع الأسئلة والإجابات','ok');
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        status.textContent = `🎧 سؤال ${i+1} من ${qa.length}`;
        updateProgress(50 + ((i+1)/qa.length) * 25);
        
        await speak('السؤال ' + (i+1));
        await delay(delayTime * 0.4);
        await speak(qa[i].q);
        await delay(delayTime * 0.6);
        await speak('الإجابة');
        await delay(delayTime * 0.4);
        await speak(qa[i].a);
        await delay(delayTime);
      }
      
      if(shouldStop) return false;
      
      completedStages.add(3);
      updateStageIndicator(3);
      status.textContent = '✅ انتهت المرحلة 3';
      showFeedback('✅ انتهت المرحلة 3 - الاستماع الكامل','success');
      return true;
    }

    document.getElementById('stage3').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      hideStats();
      
      await runStage3();
      
      isProcessing = false;
      disableButtons(false);
    };

    // المرحلة 4: تسميع نهائي
    async function runStage4(){
      if(qa.length===0){ 
        showFeedback('⚠️ لا توجد أسئلة للتسميع','warning'); 
        return false; 
      }
      if(!SpeechRecognition){ 
        showFeedback('❌ التعرف على الصوت غير مدعوم','bad'); 
        return false; 
      }
      
      currentStage = 4;
      updateStageIndicator(4, true);
      status.textContent = '📝 المرحلة 4 - تسميع نهائي';
      let correct = 0;
      
      showFeedback('📝 المرحلة 4: التسميع النهائي - أجب على جميع الأسئلة','ok');
      await delay(2000);
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        const {q,a} = qa[i];
        updateProgress(75 + ((i+1)/qa.length) * 25);
        
        status.textContent = `📝 سؤال ${i+1} من ${qa.length}`;
        await speak('سؤال ' + (i+1));
        await delay(delayTime * 0.4);
        await speak(q);
        await delay(delayTime * 0.5);
        
        try{
          const userTxt = await recognizeOnce('ar-SA');
          const userNorm = normalizeText(userTxt);
          const answerNorm = normalizeText(a);
          const isCorrect = (userNorm === answerNorm);
          
          if(isCorrect){ 
            correct++; 
            showFeedback(`✅ (${i+1}) صحيح`,'success'); 
            await speak('صحيح'); 
          } else { 
            showFeedback(`❌ (${i+1}) خاطئ | الصواب: "${a}"`,'bad'); 
            await speak('خاطئ');
            await delay(delayTime * 0.3);
            await speak(a); 
          }
          await delay(delayTime * 0.8);
        }catch(e){ 
          showFeedback(`⚠️ (${i+1}) خطأ في التعرف`,'warning'); 
          await delay(delayTime * 1.5);
        }
      }
      
      if(shouldStop) return false;
      
      showStats(correct, qa.length);
      completedStages.add(4);
      updateStageIndicator(4);
      
      const percentage = Math.round(correct/qa.length*100);
      status.textContent = `🎉 اكتمل التسميع! النتيجة: ${correct}/${qa.length} (${percentage}%)`;
      
      if(percentage === 100){
        showFeedback(`🎉 ممتاز! حصلت على العلامة الكاملة ${correct}/${qa.length}!`,'success');
        await speak('ممتاز جداً! لقد أتممت جميع الأسئلة بشكل صحيح');
      } else if(percentage >= 80){
        showFeedback(`👏 جيد جداً! النتيجة: ${correct}/${qa.length} (${percentage}%)`,'success');
        await speak('جيد جداً! استمر في المحاولة');
      } else {
        showFeedback(`💪 النتيجة: ${correct}/${qa.length} (${percentage}%) - حاول مرة أخرى`,'warning');
        await speak('حاول مراجعة المادة مرة أخرى');
      }
      
      return true;
    }

    document.getElementById('stage4').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      
      await runStage4();
      
      isProcessing = false;
      disableButtons(false);
    };

    // ========== تشغيل جميع المراحل ==========
    document.getElementById('startAll').onclick = async ()=>{
      if(isProcessing) return;
      if(qa.length === 0){
        showFeedback('⚠️ يجب إضافة أسئلة أولاً','warning');
        return;
      }
      
      if(!confirm('🚀 هل تريد البدء بجميع المراحل الأربعة بشكل متتالي؟\n\nالمدة المتوقعة: ' + (qa.length * 2) + '-' + (qa.length * 3) + ' دقيقة')){
        return;
      }
      
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      hideStats();
      completedStages.clear();
      updateStageIndicator(0);
      updateProgress(0);
      
      // المرحلة 1
      const stage1Success = await runStage1();
      if(!stage1Success || shouldStop){
        isProcessing = false;
        disableButtons(false);
        return;
      }
      
      if(autoProgress){
        await delay(3000);
        showFeedback('⏩ الانتقال للمرحلة 2...','ok');
        await delay(2000);
      }
      
      // المرحلة 2
      const stage2Success = await runStage2();
      if(!stage2Success || shouldStop){
        isProcessing = false;
        disableButtons(false);
        return;
      }
      
      if(autoProgress){
        await delay(3000);
        showFeedback('⏩ الانتقال للمرحلة 3...','ok');
        await delay(2000);
      }
      
      // المرحلة 3
      const stage3Success = await runStage3();
      if(!stage3Success || shouldStop){
        isProcessing = false;
        disableButtons(false);
        return;
      }
      
      if(autoProgress){
        await delay(3000);
        showFeedback('⏩ الانتقال للمرحلة النهائية 4...','ok');
        await delay(2000);
      }
      
      // المرحلة 4
      await runStage4();
      
      updateProgress(100);
      isProcessing = false;
      disableButtons(false);
      
      if(!shouldStop){
        await delay(2000);
        showFeedback('🎊 تهانينا! لقد أكملت جميع المراحل الأربعة!','success');
      }
    };

    // ========== رسالة ترحيب ==========
    setTimeout(async ()=>{
      await speak('مرحباً بك في تطبيق التسميع المتقدم');
    }, 1500);

    // تحذير عند مغادرة الصفحة
    window.addEventListener('beforeunload', (e) => {
      if(qa.length > 0){
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>