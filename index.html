<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ·Ø¨ÙŠÙ‚ ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--soft:#111827;--success:#10b981;--danger:#ef4444}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif;background:linear-gradient(180deg,#021226 0%,#041226 100%);color:#e6eef6}
    .container{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    h1{margin:0;font-size:22px;font-weight:700}
    p.lead{margin:0;color:var(--muted);font-size:14px}

    .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-top:18px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
    .form-row{display:flex;gap:8px;align-items:center}
    input,textarea,button,select{font-size:15px}
    input[type="text"],input[type="number"],textarea,select{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:inherit;transition:all 0.2s}
    input[type="text"]:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.04)}
    textarea{min-height:62px;resize:vertical}
    .btn{background:var(--accent);border:none;color:#000;padding:10px 16px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-weight:600}
    .btn:hover:not(:disabled){opacity:0.9;transform:translateY(-1px);box-shadow:0 4px 12px rgba(6,182,212,0.3)}
    .btn:active:not(:disabled){transform:translateY(0)}
    .btn:disabled{opacity:0.4;cursor:not-allowed}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted)}
    .btn.secondary:hover:not(:disabled){background:rgba(255,255,255,0.05);color:#fff}
    .btn.success{background:var(--success);color:#000}
    .btn.danger{background:var(--danger);color:#fff}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    ul.list{list-style:none;padding:0;margin:10px 0 0}
    li.item{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.05);margin-bottom:8px;display:flex;justify-content:space-between;gap:10px;transition:all 0.2s}
    li.item:hover{background:rgba(255,255,255,0.02);border-color:rgba(255,255,255,0.1)}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .small{font-size:13px;color:var(--muted)}
    .feedback{margin-top:10px;padding:10px 12px;border-radius:8px;font-size:14px}
    .ok{background:rgba(6,182,212,0.12);color:#a7f0ff;border-left:3px solid #06b6d4}
    .bad{background:rgba(255,60,60,0.08);color:#ffdede;border-left:3px solid #ef4444}
    .warning{background:rgba(251,191,36,0.12);color:#fef3c7;border-left:3px solid #f59e0b}
    .success{background:rgba(16,185,129,0.12);color:#a7f3d0;border-left:3px solid #10b981}
    footer{margin-top:24px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.05);color:var(--muted);font-size:13px}
    .voice-method{padding:10px;border-radius:6px;background:rgba(6,182,212,0.1);margin-top:8px;font-size:13px}
    .progress-bar{width:100%;height:6px;background:rgba(255,255,255,0.05);border-radius:10px;overflow:hidden;margin-top:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#06b6d4,#10b981);transition:width 0.3s ease;border-radius:10px}
    .stage-indicator{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .stage-dot{width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,0.1);transition:all 0.3s}
    .stage-dot.active{background:var(--accent);box-shadow:0 0 8px var(--accent)}
    .stage-dot.completed{background:var(--success)}
    .stats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .stat-box{flex:1;min-width:150px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.05)}
    .stat-value{font-size:24px;font-weight:700;color:var(--accent)}
    .stat-label{font-size:12px;color:var(--muted);margin-top:4px}
    @media (max-width:640px){.form-row{flex-direction:column}.stats{flex-direction:column}}
    
    /* Animations */
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .pulse{animation:pulse 2s ease-in-out infinite}
    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .slide-in{animation:slideIn 0.3s ease}
  </style>
</head>
<body dir="rtl">
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“ ØªØ·Ø¨ÙŠÙ‚ ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
        <p class="lead">Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© ÙˆØ¥Ø¬Ø§Ø¨Ø§Øª Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ø­Ù„ ØªÙØ§Ø¹Ù„ÙŠ Ù…Ø¹ Ù†Ø·Ù‚ Ø¹Ø±Ø¨ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ</p>
      </div>
    </header>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px;display:flex;align-items:center;gap:8px">
        â• Ø£Ø¶Ù Ø³Ø¤Ø§Ù„ ÙˆØ¥Ø¬Ø§Ø¨Ø©
      </h2>
      <div class="form-row" style="margin-bottom:8px">
        <input type="text" id="questionInput" placeholder="Ø£ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." autocomplete="off" />
        <input type="text" id="answerInput" placeholder="Ø£ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡Ù†Ø§..." autocomplete="off" />
        <button class="btn" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div class="small">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©.</div>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">ğŸ”§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
      
      <div style="margin-bottom:14px">
        <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù†Ø·Ù‚:</label>
        <select id="voiceMethod" style="width:100%;max-width:400px;padding:10px">
          <option value="google" selected>ğŸŒ Google TTS (Ù…ÙˆØµÙ‰ Ø¨Ù‡ - Ù†Ø·Ù‚ Ø¹Ø±Ø¨ÙŠ Ù…Ù…ØªØ§Ø²)</option>
          <option value="browser">ğŸ’» Ù…ØªØµÙØ­ (Web Speech API)</option>
        </select>
      </div>
      
      <div style="margin-bottom:14px">
        <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø·Ù‚:</label>
        <div style="display:flex;align-items:center;gap:12px">
          <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="1.0" style="flex:1;max-width:350px">
          <span id="rateValue" style="font-size:15px;color:var(--accent);font-weight:600;min-width:50px">1.0x</span>
        </div>
      </div>
      
      <div style="margin-bottom:14px">
        <label style="display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s" id="autoLabel">
          <input type="checkbox" id="autoProgress" checked style="width:18px;height:18px;cursor:pointer">
          <span>ğŸ”„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø±Ø§Ø­Ù„ (ÙŠÙ†ØªÙ‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©)</span>
        </label>
      </div>
      
      <div style="margin-bottom:14px">
        <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">Ù…Ø¯Ø© Ø§Ù„ØªÙˆÙ‚Ù Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø«Ø§Ù†ÙŠØ©):</label>
        <div style="display:flex;align-items:center;gap:12px">
          <input type="range" id="delayTime" min="0.3" max="2" step="0.1" value="0.5" style="flex:1;max-width:350px">
          <span id="delayValue" style="font-size:15px;color:var(--accent);font-weight:600;min-width:50px">0.5s</span>
        </div>
      </div>
      
      <div class="controls">
        <button class="btn secondary" id="testVoice">ğŸ”Š Ø§Ø®ØªØ¨Ø± Ø§Ù„ØµÙˆØª</button>
        <button class="btn success" id="startAll">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</button>
      </div>
      <div id="voiceInfo" class="voice-method"></div>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (<span id="qaCount">0</span>)</h2>
      <div class="small" style="margin-bottom:12px">ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£Ùˆ ØªØ´ØºÙŠÙ„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ</div>
      <ul class="list" id="qaList"></ul>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">ğŸ¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>
      
      <div class="stage-indicator">
        <div class="stage-dot" data-stage="1" title="Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1"></div>
        <div class="stage-dot" data-stage="2" title="Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2"></div>
        <div class="stage-dot" data-stage="3" title="Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3"></div>
        <div class="stage-dot" data-stage="4" title="Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4"></div>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      
      <div class="controls" style="margin-top:16px">
        <button class="btn" id="stage1">1ï¸âƒ£ Ø­ÙØ¸ (Ø³â†Ø¬ Ã—3)</button>
        <button class="btn" id="stage2">2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ØµÙˆØªÙŠ ğŸ¤</button>
        <button class="btn" id="stage3">3ï¸âƒ£ Ø§Ø³ØªÙ…Ø§Ø¹ ÙƒØ§Ù…Ù„ ğŸ§</button>
        <button class="btn" id="stage4">4ï¸âƒ£ ØªØ³Ù…ÙŠØ¹ Ù†Ù‡Ø§Ø¦ÙŠ ğŸ“</button>
        <button class="btn danger" id="stopAll">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>

      <div id="status" class="small" style="margin-top:12px;color:var(--muted);font-weight:600">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡</div>
      <div id="feedback" class="feedback" style="display:none"></div>
      
      <div class="stats" id="statsContainer" style="display:none">
        <div class="stat-box">
          <div class="stat-value" id="correctCount">0</div>
          <div class="stat-label">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="percentageCount">0%</div>
          <div class="stat-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
        </div>
      </div>
    </section>

    <section class="card slide-in">
      <h2 style="font-size:16px;margin:0 0 12px">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø©</h2>
      <div class="controls">
        <button class="btn secondary" id="clearStorage">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
        <button class="btn secondary" id="exportData">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn secondary" id="importData">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </section>

    <footer>
      <div class="small">
        <strong>ğŸ’¡ Ù†ØµØ§Ø¦Ø­:</strong> Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø³Ù…Ø§Ø¹Ø§Øª Ø§Ù„Ø±Ø£Ø³ ÙˆØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.
        Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³ØªØ®Ø¯Ù… Google TTS Ù„Ù„Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ.
      </div>
      <div class="small" style="margin-top:8px">
        ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Claude AI | ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù…
      </div>
    </footer>
  </div>

  <script>
    // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
    let qa = [];
    let isProcessing = false;
    let shouldStop = false;
    let currentVoiceMethod = 'google';
    let speechRate = 1.0;
    let autoProgress = true;
    let delayTime = 500;
    let currentStage = 0;
    let completedStages = new Set();

    // ========== Ø§Ù„Ø¹Ù†Ø§ØµØ± ==========
    const qInput = document.getElementById('questionInput');
    const aInput = document.getElementById('answerInput');
    const addBtn = document.getElementById('addBtn');
    const qaList = document.getElementById('qaList');
    const qaCount = document.getElementById('qaCount');
    const status = document.getElementById('status');
    const feedback = document.getElementById('feedback');
    const voiceInfo = document.getElementById('voiceInfo');
    const voiceMethodSelect = document.getElementById('voiceMethod');
    const speechRateSlider = document.getElementById('speechRate');
    const rateValue = document.getElementById('rateValue');
    const autoProgressCheck = document.getElementById('autoProgress');
    const delayTimeSlider = document.getElementById('delayTime');
    const delayValue = document.getElementById('delayValue');
    const progressFill = document.getElementById('progressFill');
    const statsContainer = document.getElementById('statsContainer');
    const correctCountEl = document.getElementById('correctCount');
    const totalCountEl = document.getElementById('totalCount');
    const percentageCountEl = document.getElementById('percentageCount');

    // ========== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ==========
    voiceMethodSelect.onchange = ()=>{
      currentVoiceMethod = voiceMethodSelect.value;
      updateVoiceInfo();
    };

    speechRateSlider.oninput = ()=>{
      speechRate = parseFloat(speechRateSlider.value);
      rateValue.textContent = speechRate.toFixed(1) + 'x';
    };

    autoProgressCheck.onchange = ()=>{
      autoProgress = autoProgressCheck.checked;
    };

    delayTimeSlider.oninput = ()=>{
      delayTime = parseFloat(delayTimeSlider.value) * 1000;
      delayValue.textContent = (delayTime/1000).toFixed(1) + 's';
    };

    function updateVoiceInfo(){
      if(currentVoiceMethod === 'google'){
        voiceInfo.innerHTML = 'âœ… ÙŠØ³ØªØ®Ø¯Ù… Google TTS - Ù†Ø·Ù‚ Ø¹Ø±Ø¨ÙŠ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙˆØ§Ø¶Ø­';
        voiceInfo.style.background = 'rgba(6,182,212,0.1)';
        voiceInfo.style.color = '#a7f0ff';
      } else {
        voiceInfo.innerHTML = 'âš ï¸ ÙŠØ³ØªØ®Ø¯Ù… Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ØªØµÙØ­ - Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø·Ù‚ Ø£Ù‚Ù„ ÙˆØ¶ÙˆØ­Ø§Ù‹';
        voiceInfo.style.background = 'rgba(251,191,36,0.1)';
        voiceInfo.style.color = '#fef3c7';
      }
    }

    updateVoiceInfo();

    // ========== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
    function normalizeText(s){
      if(!s) return '';
      s = s.toString();
      s = s.replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'');
      s = s.replace(/[\u2000-\u206F\u2E00-\u2E7F\`\~\!\@\#\$\%\^\&\*\(\)\-_\+=\[\]\\\{\}\|\;\:\"\'\<\>,\.\?\/]/g,'');
      s = s.replace(/\s+/g,' ').trim().toLowerCase();
      return s;
    }

    function escapeHtml(s){ 
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); 
    }

    function delay(ms){ 
      return new Promise(r=>setTimeout(r,ms)); 
    }

    function disableButtons(disabled){
      document.querySelectorAll('.btn').forEach(btn => {
        if(btn.id !== 'stopAll'){
          btn.disabled = disabled;
        }
      });
    }

    function updateProgress(percentage){
      progressFill.style.width = percentage + '%';
    }

    function updateStageIndicator(stage, isActive = false){
      document.querySelectorAll('.stage-dot').forEach(dot => {
        const dotStage = parseInt(dot.dataset.stage);
        dot.classList.remove('active');
        if(dotStage < stage){
          dot.classList.add('completed');
        } else if(dotStage === stage && isActive){
          dot.classList.add('active');
        } else if(dotStage > stage){
          dot.classList.remove('completed');
        }
      });
    }

    function showStats(correct, total){
      const percentage = total > 0 ? Math.round(correct/total*100) : 0;
      correctCountEl.textContent = correct;
      totalCountEl.textContent = total;
      percentageCountEl.textContent = percentage + '%';
      statsContainer.style.display = 'flex';
    }

    function hideStats(){
      statsContainer.style.display = 'none';
    }

    function showFeedback(msg, type='ok'){
      feedback.style.display = 'block';
      feedback.textContent = msg;
      feedback.className = 'feedback slide-in ' + type;
    }

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ==========
    function updateQACount(){
      qaCount.textContent = qa.length;
    }

    function renderList(){
      qaList.innerHTML = '';
      if(qa.length===0){
        qaList.innerHTML = '<li class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„!</li>';
        updateQACount();
        return;
      }
      
      qa.forEach((item,idx)=>{
        const li = document.createElement('li'); 
        li.className='item';
        li.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:600;font-size:15px">${escapeHtml(item.q)}</div>
            <div class="meta">âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${escapeHtml(item.a)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start">
            <button class="btn secondary" data-idx="${idx}" style="padding:6px 12px;font-size:13px">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <button class="btn secondary" data-play="${idx}" style="padding:6px 12px;font-size:13px">ğŸ”Š ØªØ´ØºÙŠÙ„</button>
          </div>
        `;
        qaList.appendChild(li);
      });

      qaList.querySelectorAll('button[data-idx]').forEach(b=>{
        b.onclick = ()=>{ 
          const i = +b.dataset.idx;
          if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')){
            qa.splice(i,1); 
            renderList();
            showFeedback('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ“','ok');
            setTimeout(()=>feedback.style.display='none', 2000);
          }
        }
      });
      
      qaList.querySelectorAll('button[data-play]').forEach(b=>{
        b.onclick = ()=>{ 
          const i = +b.dataset.play; 
          speakQA(qa[i].q, qa[i].a); 
        }
      });
      
      updateQACount();
    }

    addBtn.onclick = ()=>{
      const q = qInput.value.trim();
      const a = aInput.value.trim();
      if(!q || !a){ 
        showFeedback('âš ï¸ ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©','warning'); 
        return; 
      }
      qa.push({q,a}); 
      renderList(); 
      qInput.value=''; 
      aInput.value=''; 
      qInput.focus(); 
      showFeedback('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­','success');
      setTimeout(()=>feedback.style.display='none', 2000);
    }

    // Enter Ù„Ù„Ø¥Ø¶Ø§ÙØ©
    aInput.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter') addBtn.click();
    });

    document.getElementById('clearStorage').onclick = ()=>{
      if(!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) return; 
      qa=[]; 
      renderList(); 
      hideStats();
      completedStages.clear();
      updateStageIndicator(0);
      updateProgress(0);
      showFeedback('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©','success');
    }

    // ========== ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ ==========
    document.getElementById('exportData').onclick = ()=>{
      if(qa.length === 0){
        showFeedback('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù„ØªØµØ¯ÙŠØ±','warning');
        return;
      }
      const dataStr = JSON.stringify(qa, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'Ø§Ø³Ø¦Ù„Ø©-ÙˆØ¥Ø¬Ø§Ø¨Ø§Øª-' + new Date().toISOString().split('T')[0] + '.json';
      link.click();
      URL.revokeObjectURL(url);
      showFeedback('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success');
    };

    document.getElementById('importData').onclick = ()=>{
      document.getElementById('fileInput').click();
    };

    document.getElementById('fileInput').onchange = (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const imported = JSON.parse(ev.target.result);
          if(Array.isArray(imported)){
            qa = imported;
            renderList();
            showFeedback('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ' + qa.length + ' Ø³Ø¤Ø§Ù„','success');
          } else {
            showFeedback('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­','bad');
          }
        }catch(err){
          showFeedback('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù','bad');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    };

    renderList();

    // ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø·Ù‚ ==========
    function speakWithGoogle(text, rate = 1.0){
      return new Promise((resolve)=>{
        try{
          const audio = new Audio();
          const encodedText = encodeURIComponent(text);
          audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ar&client=tw-ob&q=${encodedText}`;
          audio.playbackRate = rate;
          
          audio.onended = ()=> resolve();
          audio.onerror = ()=> {
            console.error('Ø®Ø·Ø£ ÙÙŠ Google TTS');
            resolve();
          };
          
          audio.play().catch(e => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
            resolve();
          });
        } catch(e){
          console.error('Ø®Ø·Ø£:', e);
          resolve();
        }
      });
    }

    function speakWithBrowser(text, rate = 1.0){
      return new Promise((resolve)=>{
        const synth = window.speechSynthesis;
        if(!synth){
          resolve();
          return;
        }

        synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        
        const voices = synth.getVoices();
        const arabicVoice = voices.find(v => 
          v.lang.startsWith('ar') || v.name.includes('Arabic')
        );
        
        if(arabicVoice){
          utter.voice = arabicVoice;
          utter.lang = arabicVoice.lang;
        } else {
          utter.lang = 'ar-SA';
        }
        
        utter.rate = rate * 0.85;
        utter.pitch = 1.0;
        utter.volume = 1.0;
        
        utter.onend = ()=>resolve();
        utter.onerror = ()=>resolve();
        
        synth.speak(utter);
      });
    }

    function speak(text, rate = null){
      if(shouldStop) return Promise.resolve();
      const actualRate = rate !== null ? rate : speechRate;
      
      if(currentVoiceMethod === 'google'){
        return speakWithGoogle(text, actualRate);
      } else {
        return speakWithBrowser(text, actualRate);
      }
    }

    async function speakQA(q,a){
      if(isProcessing) return;
      isProcessing = true;
      status.textContent = 'ğŸ”Š ØªØ´ØºÙŠÙ„ Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯...';
      await speak(q);
      await delay(delayTime);
      await speak(a);
      status.textContent = 'ğŸ“Š Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡';
      isProcessing = false;
    }

    // ========== Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª ==========
    document.getElementById('testVoice').onclick = async ()=>{
      if(isProcessing) return;
      showFeedback('ğŸ”Š Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª...','ok');
      await speak('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØµÙˆØª Ø§Ù„Ø¹Ø±Ø¨ÙŠ. Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ' + speechRate.toFixed(1));
      showFeedback('âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­','success');
      setTimeout(()=>feedback.style.display='none', 3000);
    };

    // ========== Ø¥ÙŠÙ‚Ø§Ù ==========
    document.getElementById('stopAll').onclick = ()=>{
      shouldStop = true;
      isProcessing = false;
      disableButtons(false);
      status.textContent = 'â¹ï¸ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';
      showFeedback('â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©','warning');
      if(window.speechSynthesis) window.speechSynthesis.cancel();
    };

    // ========== Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ==========
    
    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø­ÙØ¸
    async function runStage1(){
      if(qa.length===0){ 
        showFeedback('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1','warning'); 
        return false; 
      }
      
      currentStage = 1;
      updateStageIndicator(1, true);
      status.textContent = 'ğŸ¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 - Ø§Ù„Ø­ÙØ¸';
      showFeedback('ğŸ¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø³ÙŠØªÙ… Ù†Ø·Ù‚ ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ø«Ù… Ø¥Ø¬Ø§Ø¨ØªÙ‡ 3 Ù…Ø±Ø§Øª','ok');
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        const {q,a} = qa[i];
        status.textContent = `ğŸ¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 - Ø³Ø¤Ø§Ù„ ${i+1} Ù…Ù† ${qa.length}`;
        updateProgress(((i+1)/qa.length) * 25);
        
        for(let r=0; r<3 && !shouldStop; r++){
          await speak(q);
          await delay(delayTime * 0.6);
          await speak(a);
          await delay(delayTime * 0.8);
        }
      }
      
      if(shouldStop) return false;
      
      completedStages.add(1);
      updateStageIndicator(1);
      status.textContent = 'âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1';
      showFeedback('âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 - Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­','success');
      return true;
    }

    document.getElementById('stage1').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      hideStats();
      
      await runStage1();
      
      isProcessing = false;
      disableButtons(false);
    };

    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ø®ØªØ¨Ø§Ø± ØµÙˆØªÙŠ
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    
    function recognizeOnce(lang='ar-SA'){
      return new Promise((res,rej)=>{
        if(!SpeechRecognition){ 
          rej(new Error('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… SpeechRecognition')); 
          return; 
        }
        
        const rec = new SpeechRecognition();
        rec.lang = lang; 
        rec.interimResults = false; 
        rec.maxAlternatives = 1;
        
        rec.onresult = (ev)=>{ 
          const txt = ev.results[0][0].transcript; 
          res(txt); 
        };
        
        rec.onerror = (e)=>rej(e);
        rec.onend = ()=>{};
        
        try{ 
          rec.start(); 
        }catch(e){ 
          rej(e); 
        }
      });
    }

    async function runStage2(){
      if(qa.length===0){ 
        showFeedback('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±','warning'); 
        return false; 
      }
      if(!SpeechRecognition){ 
        showFeedback('âŒ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­Ø©. Ø§Ø³ØªØ®Ø¯Ù… Chrome/Edge.','bad'); 
        return false; 
      }
      
      currentStage = 2;
      updateStageIndicator(2, true);
      status.textContent = 'ğŸ¤ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 - Ø§Ø®ØªØ¨Ø§Ø± ØµÙˆØªÙŠ';
      let correct = 0;
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        const {q,a} = qa[i];
        updateProgress(25 + ((i+1)/qa.length) * 25);
        
        await speak(q);
        await delay(delayTime * 0.5);
        
        status.textContent = `ğŸ¤ Ø³Ø¤Ø§Ù„ ${i+1} Ù…Ù† ${qa.length} - Ø§Ø¬Ø¨ Ø§Ù„Ø¢Ù†`;
        showFeedback(`ğŸ¤ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i+1}: Ø§Ø³ØªÙ…Ø¹ ÙˆØ£Ø¬ÙØ¨ Ø¨ØµÙˆØª ÙˆØ§Ø¶Ø­`,'ok');
        
        try{
          const userTxt = await recognizeOnce('ar-SA');
          const userNorm = normalizeText(userTxt);
          const answerNorm = normalizeText(a);
          const isCorrect = (userNorm === answerNorm);
          
          if(isCorrect){ 
            correct++; 
            showFeedback(`âœ… (${i+1}) Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©: "${userTxt}"`,'success'); 
            await speak('Ù…Ù…ØªØ§Ø²ØŒ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©'); 
          } else { 
            showFeedback(`âŒ (${i+1}) Ø®Ø§Ø·Ø¦ - Ù‚Ù„Øª: "${userTxt}" | Ø§Ù„ØµÙˆØ§Ø¨: "${a}"`,'bad'); 
            await speak('Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©');
            await delay(delayTime * 0.4);
            await speak('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ');
            await delay(delayTime * 0.3);
            await speak(a); 
          }
          await delay(delayTime);
        }catch(e){ 
          showFeedback(`âš ï¸ (${i+1}) Ù„Ù… ÙŠØªÙ… Ø³Ù…Ø§Ø¹ Ø¥Ø¬Ø§Ø¨ØªÙƒ - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†`,'warning'); 
          await delay(delayTime * 2);
        }
      }
      
      if(shouldStop) return false;
      
      showStats(correct, qa.length);
      completedStages.add(2);
      updateStageIndicator(2);
      
      const percentage = Math.round(correct/qa.length*100);
      status.textContent = `âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2 - Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${correct}/${qa.length} (${percentage}%)`;
      showFeedback(`âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2! Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${correct} Ù…Ù† ${qa.length} (${percentage}%)`, 
        percentage >= 80 ? 'success' : 'warning');
      return true;
    }

    document.getElementById('stage2').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      
      await runStage2();
      
      isProcessing = false;
      disableButtons(false);
    };

    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø³ØªÙ…Ø§Ø¹ ÙƒØ§Ù…Ù„
    async function runStage3(){
      if(qa.length===0){ 
        showFeedback('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹','warning'); 
        return false; 
      }
      
      currentStage = 3;
      updateStageIndicator(3, true);
      status.textContent = 'ğŸ§ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3 - Ø§Ø³ØªÙ…Ø§Ø¹ ÙƒØ§Ù…Ù„';
      showFeedback('ğŸ§ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª','ok');
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        status.textContent = `ğŸ§ Ø³Ø¤Ø§Ù„ ${i+1} Ù…Ù† ${qa.length}`;
        updateProgress(50 + ((i+1)/qa.length) * 25);
        
        await speak('Ø§Ù„Ø³Ø¤Ø§Ù„ ' + (i+1));
        await delay(delayTime * 0.4);
        await speak(qa[i].q);
        await delay(delayTime * 0.6);
        await speak('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
        await delay(delayTime * 0.4);
        await speak(qa[i].a);
        await delay(delayTime);
      }
      
      if(shouldStop) return false;
      
      completedStages.add(3);
      updateStageIndicator(3);
      status.textContent = 'âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3';
      showFeedback('âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3 - Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„','success');
      return true;
    }

    document.getElementById('stage3').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      hideStats();
      
      await runStage3();
      
      isProcessing = false;
      disableButtons(false);
    };

    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ØªØ³Ù…ÙŠØ¹ Ù†Ù‡Ø§Ø¦ÙŠ
    async function runStage4(){
      if(qa.length===0){ 
        showFeedback('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù„ØªØ³Ù…ÙŠØ¹','warning'); 
        return false; 
      }
      if(!SpeechRecognition){ 
        showFeedback('âŒ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…','bad'); 
        return false; 
      }
      
      currentStage = 4;
      updateStageIndicator(4, true);
      status.textContent = 'ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4 - ØªØ³Ù…ÙŠØ¹ Ù†Ù‡Ø§Ø¦ÙŠ';
      let correct = 0;
      
      showFeedback('ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ - Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©','ok');
      await delay(2000);
      
      for(let i=0; i<qa.length && !shouldStop; i++){
        const {q,a} = qa[i];
        updateProgress(75 + ((i+1)/qa.length) * 25);
        
        status.textContent = `ğŸ“ Ø³Ø¤Ø§Ù„ ${i+1} Ù…Ù† ${qa.length}`;
        await speak('Ø³Ø¤Ø§Ù„ ' + (i+1));
        await delay(delayTime * 0.4);
        await speak(q);
        await delay(delayTime * 0.5);
        
        try{
          const userTxt = await recognizeOnce('ar-SA');
          const userNorm = normalizeText(userTxt);
          const answerNorm = normalizeText(a);
          const isCorrect = (userNorm === answerNorm);
          
          if(isCorrect){ 
            correct++; 
            showFeedback(`âœ… (${i+1}) ØµØ­ÙŠØ­`,'success'); 
            await speak('ØµØ­ÙŠØ­'); 
          } else { 
            showFeedback(`âŒ (${i+1}) Ø®Ø§Ø·Ø¦ | Ø§Ù„ØµÙˆØ§Ø¨: "${a}"`,'bad'); 
            await speak('Ø®Ø§Ø·Ø¦');
            await delay(delayTime * 0.3);
            await speak(a); 
          }
          await delay(delayTime * 0.8);
        }catch(e){ 
          showFeedback(`âš ï¸ (${i+1}) Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù`,'warning'); 
          await delay(delayTime * 1.5);
        }
      }
      
      if(shouldStop) return false;
      
      showStats(correct, qa.length);
      completedStages.add(4);
      updateStageIndicator(4);
      
      const percentage = Math.round(correct/qa.length*100);
      status.textContent = `ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ³Ù…ÙŠØ¹! Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${correct}/${qa.length} (${percentage}%)`;
      
      if(percentage === 100){
        showFeedback(`ğŸ‰ Ù…Ù…ØªØ§Ø²! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ${correct}/${qa.length}!`,'success');
        await speak('Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹! Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
      } else if(percentage >= 80){
        showFeedback(`ğŸ‘ Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${correct}/${qa.length} (${percentage}%)`,'success');
        await speak('Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
      } else {
        showFeedback(`ğŸ’ª Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${correct}/${qa.length} (${percentage}%) - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰`,'warning');
        await speak('Ø­Ø§ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
      }
      
      return true;
    }

    document.getElementById('stage4').onclick = async ()=>{
      if(isProcessing) return;
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      
      await runStage4();
      
      isProcessing = false;
      disableButtons(false);
    };

    // ========== ØªØ´ØºÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ==========
    document.getElementById('startAll').onclick = async ()=>{
      if(isProcessing) return;
      if(qa.length === 0){
        showFeedback('âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹','warning');
        return;
      }
      
      if(!confirm('ğŸš€ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªØªØ§Ù„ÙŠØŸ\n\nØ§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: ' + (qa.length * 2) + '-' + (qa.length * 3) + ' Ø¯Ù‚ÙŠÙ‚Ø©')){
        return;
      }
      
      shouldStop = false;
      isProcessing = true;
      disableButtons(true);
      hideStats();
      completedStages.clear();
      updateStageIndicator(0);
      updateProgress(0);
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1
      const stage1Success = await runStage1();
      if(!stage1Success || shouldStop){
        isProcessing = false;
        disableButtons(false);
        return;
      }
      
      if(autoProgress){
        await delay(3000);
        showFeedback('â© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© 2...','ok');
        await delay(2000);
      }
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2
      const stage2Success = await runStage2();
      if(!stage2Success || shouldStop){
        isProcessing = false;
        disableButtons(false);
        return;
      }
      
      if(autoProgress){
        await delay(3000);
        showFeedback('â© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© 3...','ok');
        await delay(2000);
      }
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3
      const stage3Success = await runStage3();
      if(!stage3Success || shouldStop){
        isProcessing = false;
        disableButtons(false);
        return;
      }
      
      if(autoProgress){
        await delay(3000);
        showFeedback('â© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© 4...','ok');
        await delay(2000);
      }
      
      // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4
      await runStage4();
      
      updateProgress(100);
      isProcessing = false;
      disableButtons(false);
      
      if(!shouldStop){
        await delay(2000);
        showFeedback('ğŸŠ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©!','success');
      }
    };

    // ========== Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ ==========
    setTimeout(async ()=>{
      await speak('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');
    }, 1500);

    // ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', (e) => {
      if(qa.length > 0){
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>