<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تطبيق تسميع الأسئلة والإجابات</title>
  <style>
    :root{
      --bg:#0a0e1a;--card:#0f1420;--accent:#06b6d4;--accent-hover:#0891b2;
      --muted:#94a3b8;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;
      --purple:#a855f7;--pink:#ec4899;--indigo:#6366f1;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif,-apple-system,'Noto Sans Arabic',sans-serif;
      background:linear-gradient(135deg,#0a0e1a 0%,#1a1f35 50%,#0a0e1a 100%);color:#e6eef6;overflow-x:hidden}
    
    .container{max-width:1200px;margin:0 auto;padding:20px}
    
    /* Header */
    header{
      background:linear-gradient(135deg,rgba(6,182,212,0.1) 0%,rgba(168,85,247,0.1) 100%);
      border-radius:20px;padding:30px;margin-bottom:30px;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      position:relative;overflow:hidden
    }
    header::before{
      content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;
      background:radial-gradient(circle,rgba(6,182,212,0.1) 0%,transparent 70%);
      animation:rotate 20s linear infinite
    }
    @keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    h1{margin:0;font-size:32px;font-weight:800;background:linear-gradient(135deg,#06b6d4,#a855f7);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:1}
    p.lead{margin:8px 0 0;color:var(--muted);font-size:15px;position:relative;z-index:1}
    
    /* Cards */
    .card{
      background:rgba(15,20,32,0.6);backdrop-filter:blur(10px);border-radius:16px;
      padding:24px;margin-bottom:24px;border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 8px 32px rgba(0,0,0,0.4);transition:all 0.3s
    }
    .card:hover{border-color:rgba(6,182,212,0.3);transform:translateY(-2px)}
    
    .card-title{
      font-size:18px;font-weight:700;margin:0 0 16px;
      display:flex;align-items:center;gap:10px;color:#fff
    }
    
    /* Form Elements */
    input[type="text"],input[type="number"],textarea,select{
      width:100%;padding:12px 16px;border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.03);color:#fff;
      font-size:15px;transition:all 0.3s;font-family:inherit
    }
    input:focus,textarea:focus,select:focus{
      outline:none;border-color:var(--accent);
      background:rgba(255,255,255,0.06);
      box-shadow:0 0 0 3px rgba(6,182,212,0.1)
    }
    
    .form-row{display:flex;gap:12px;margin-bottom:12px}
    
    /* Buttons */
    .btn{
      padding:12px 20px;border-radius:10px;border:none;
      font-size:14px;font-weight:600;cursor:pointer;
      transition:all 0.3s;display:inline-flex;align-items:center;gap:8px;
      font-family:inherit
    }
    .btn:disabled{opacity:0.4;cursor:not-allowed}
    
    .btn-primary{
      background:linear-gradient(135deg,#06b6d4,#0891b2);color:#000;
      box-shadow:0 4px 16px rgba(6,182,212,0.3)
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);box-shadow:0 6px 24px rgba(6,182,212,0.4)
    }
    
    .btn-secondary{
      background:rgba(255,255,255,0.05);color:var(--muted);
      border:1px solid rgba(255,255,255,0.1)
    }
    .btn-secondary:hover:not(:disabled){
      background:rgba(255,255,255,0.1);color:#fff;border-color:rgba(255,255,255,0.2)
    }
    
    .btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#000}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
    .btn-warning{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000}
    .btn-purple{background:linear-gradient(135deg,#a855f7,#9333ea);color:#fff}
    
    .btn-group{display:flex;gap:10px;flex-wrap:wrap}
    
    /* Lists */
    .list{list-style:none;padding:0;margin:0}
    .list-item{
      background:rgba(255,255,255,0.02);border-radius:12px;
      padding:16px;margin-bottom:12px;
      border:1px solid rgba(255,255,255,0.05);
      display:flex;justify-content:space-between;gap:16px;
      transition:all 0.3s
    }
    .list-item:hover{
      background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.15);
      transform:translateX(-4px)
    }
    
    /* Stage Cards */
    .stage-card{
      background:rgba(255,255,255,0.02);border-radius:12px;
      padding:20px;margin-bottom:16px;
      border:1px solid rgba(255,255,255,0.08);
      transition:all 0.3s;position:relative
    }
    .stage-card.active{
      border-color:var(--accent);
      box-shadow:0 0 20px rgba(6,182,212,0.2)
    }
    .stage-card.completed{
      border-color:var(--success);opacity:0.7
    }
    
    .stage-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:12px
    }
    .stage-number{
      width:40px;height:40px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--purple));
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;color:#000
    }
    .stage-title{font-size:16px;font-weight:600;flex:1;margin:0 16px}
    
    .stage-config{
      background:rgba(255,255,255,0.03);border-radius:8px;
      padding:12px;margin-top:12px;border:1px solid rgba(255,255,255,0.05)
    }
    
    /* Modal */
    .modal{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);
      z-index:1000;align-items:center;justify-content:center;
      animation:fadeIn 0.3s
    }
    .modal.show{display:flex}
    .modal-content{
      background:linear-gradient(135deg,#0f1420 0%,#1a1f35 100%);
      border-radius:20px;padding:30px;max-width:600px;width:90%;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 60px rgba(0,0,0,0.8);
      max-height:90vh;overflow-y:auto
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:20px;padding-bottom:16px;
      border-bottom:1px solid rgba(255,255,255,0.1)
    }
    .modal-title{font-size:22px;font-weight:700;margin:0}
    .close-btn{
      background:rgba(255,255,255,0.1);border:none;
      width:32px;height:32px;border-radius:50%;
      cursor:pointer;font-size:20px;color:#fff;
      display:flex;align-items:center;justify-content:center;
      transition:all 0.3s
    }
    .close-btn:hover{background:var(--danger);transform:rotate(90deg)}
    
    /* Progress */
    .progress-bar{
      width:100%;height:8px;background:rgba(255,255,255,0.05);
      border-radius:10px;overflow:hidden;margin:16px 0
    }
    .progress-fill{
      height:100%;background:linear-gradient(90deg,#06b6d4,#a855f7);
      transition:width 0.5s ease;border-radius:10px
    }
    
    /* Status */
    .status{
      padding:16px;border-radius:12px;margin:16px 0;
      display:flex;align-items:center;gap:12px;font-weight:600
    }
    .status.ok{background:rgba(6,182,212,0.15);color:#a7f0ff;border-left:4px solid #06b6d4}
    .status.success{background:rgba(16,185,129,0.15);color:#a7f3d0;border-left:4px solid #10b981}
    .status.warning{background:rgba(245,158,11,0.15);color:#fef3c7;border-left:4px solid #f59e0b}
    .status.bad{background:rgba(239,68,68,0.15);color:#ffdede;border-left:4px solid #ef4444}
    
    /* Stats */
    .stats{display:flex;gap:16px;margin-top:20px}
    .stat-box{
      flex:1;background:rgba(255,255,255,0.03);border-radius:12px;
      padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.05)
    }
    .stat-value{
      font-size:36px;font-weight:800;
      background:linear-gradient(135deg,#06b6d4,#a855f7);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent
    }
    .stat-label{font-size:13px;color:var(--muted);margin-top:8px}
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .slide-up{animation:slideUp 0.4s ease}
    
    /* Responsive */
    @media (max-width:768px){
      .container{padding:12px}
      header{padding:20px}
      h1{font-size:24px}
      .form-row{flex-direction:column}
      .stats{flex-direction:column}
      .modal-content{padding:20px}
    }
    
    /* Settings Grid */
    .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0}
    @media (max-width:768px){.settings-grid{grid-template-columns:1fr}}
    
    .setting-item{
      background:rgba(255,255,255,0.02);padding:16px;
      border-radius:10px;border:1px solid rgba(255,255,255,0.05)
    }
    .setting-label{
      font-size:13px;font-weight:600;color:var(--muted);
      margin-bottom:8px;display:block
    }
    
    /* Range Slider */
    input[type="range"]{
      width:100%;height:6px;border-radius:5px;
      background:rgba(255,255,255,0.1);outline:none;
      -webkit-appearance:none
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;width:18px;height:18px;
      border-radius:50%;background:var(--accent);cursor:pointer;
      box-shadow:0 2px 8px rgba(6,182,212,0.4)
    }
    
    /* Checkbox */
    input[type="checkbox"]{
      width:20px;height:20px;cursor:pointer;
      accent-color:var(--accent)
    }
    
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body dir="rtl">
  <div class="container">
    <header class="slide-up">
      <h1>🎓 تطبيق التسميع الذكي</h1>
      <p class="lead">منصة تعليمية متقدمة مع مراحل قابلة للتخصيص الكامل</p>
    </header>

    <div class="card slide-up">
      <h2 class="card-title">➕ إضافة سؤال جديد</h2>
      <div class="form-row">
        <input type="text" id="questionInput" placeholder="اكتب السؤال..." />
        <input type="text" id="answerInput" placeholder="اكتب الإجابة..." />
        <button class="btn btn-primary" id="addBtn">إضافة</button>
      </div>
    </div>

    <div class="card slide-up">
      <h2 class="card-title">📝 الأسئلة (<span id="qaCount">0</span>)</h2>
      <ul class="list" id="qaList"></ul>
    </div>

    <div class="card slide-up">
      <h2 class="card-title">⚙️ الإعدادات العامة</h2>
      <div class="settings-grid">
        <div class="setting-item">
          <label class="setting-label">🗣️ طريقة النطق</label>
          <select id="voiceMethod">
            <option value="google" selected>Google TTS (موصى به)</option>
            <option value="browser">أصوات المتصفح</option>
          </select>
        </div>
        <div class="setting-item">
          <label class="setting-label">⚡ سرعة النطق: <span id="rateValue">1.0x</span></label>
          <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="1.0">
        </div>
        <div class="setting-item">
          <label class="setting-label">⏱️ التوقف بين الأسئلة: <span id="delayValue">0.5s</span></label>
          <input type="range" id="delayTime" min="0.3" max="2" step="0.1" value="0.5">
        </div>
        <div class="setting-item">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="autoProgress" checked>
            <span>🔄 الانتقال التلقائي للمراحل</span>
          </label>
        </div>
      </div>
      <button class="btn btn-secondary" id="testVoice">🔊 اختبار الصوت</button>
    </div>

    <div class="card slide-up">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 class="card-title" style="margin:0">🎯 المراحل التعليمية</h2>
        <button class="btn btn-purple" id="addStageBtn">➕ إضافة مرحلة</button>
      </div>
      
      <div id="stagesList"></div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:0%"></div>
      </div>
      
      <div class="btn-group" style="margin-top:20px">
        <button class="btn btn-success" id="startAll">▶️ بدء جميع المراحل</button>
        <button class="btn btn-danger" id="stopAll">⏹️ إيقاف</button>
      </div>
      
      <div id="statusMsg" class="small" style="margin-top:16px;font-weight:600">📊 الحالة: جاهز</div>
      <div id="feedback" style="display:none"></div>
      
      <div class="stats" id="statsContainer" style="display:none">
        <div class="stat-box">
          <div class="stat-value" id="correctCount">0</div>
          <div class="stat-label">✅ صحيح</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">📝 الإجمالي</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="percentageCount">0%</div>
          <div class="stat-label">🎯 النجاح</div>
        </div>
      </div>
    </div>

    <div class="card slide-up">
      <h2 class="card-title">🔧 أدوات</h2>
      <div class="btn-group">
        <button class="btn btn-secondary" id="exportData">📥 تصدير</button>
        <button class="btn btn-secondary" id="importData">📤 استيراد</button>
        <button class="btn btn-danger" id="clearAll">🗑️ مسح الكل</button>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </div>
  </div>

  <!-- Modal لإضافة/تعديل المراحل -->
  <div class="modal" id="stageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">➕ إضافة مرحلة جديدة</h3>
        <button class="close-btn" id="closeModal">×</button>
      </div>
      
      <div style="margin-bottom:16px">
        <label class="setting-label">📌 اسم المرحلة</label>
        <input type="text" id="stageName" placeholder="مثال: الحفظ السريع">
      </div>
      
      <div style="margin-bottom:16px">
        <label class="setting-label">🎭 نوع المرحلة</label>
        <select id="stageType">
          <option value="listen">🎧 الاستماع (يقرأ السؤال والإجابة)</option>
          <option value="repeat">🔄 التكرار (يكرر عدة مرات)</option>
          <option value="test">🎤 الاختبار (أنت تجيب بالصوت)</option>
          <option value="reverse">🔁 عكسي (يقرأ الإجابة ثم السؤال)</option>
          <option value="userRead">📖 أنت تقرأ (التطبيق يستمع لك)</option>
          <option value="random">🎲 عشوائي (ترتيب عشوائي)</option>
          <option value="quiz">❓ اختيارات متعددة</option>
        </select>
      </div>
      
      <div id="stageOptions"></div>
      
      <div class="btn-group" style="margin-top:20px">
        <button class="btn btn-primary" id="saveStageBtn">💾 حفظ المرحلة</button>
        <button class="btn btn-secondary" id="cancelStageBtn">❌ إلغاء</button>
      </div>
    </div>
  </div>

  <script>
    // ========== البيانات ==========
    let qa = [];
    let stages = [
      {id:1,name:'الحفظ الأساسي',type:'repeat',config:{times:3},enabled:true},
      {id:2,name:'اختبار صوتي',type:'test',config:{},enabled:true},
      {id:3,name:'الاستماع الكامل',type:'listen',config:{},enabled:true},
      {id:4,name:'التسميع النهائي',type:'test',config:{},enabled:true}
    ];
    let isProcessing = false;
    let shouldStop = false;
    let currentVoiceMethod = 'google';
    let speechRate = 1.0;
    let delayTime = 500;
    let autoProgress = true;
    let editingStageId = null;

    // ========== العناصر ==========
    const qInput = document.getElementById('questionInput');
    const aInput = document.getElementById('answerInput');
    const qaList = document.getElementById('qaList');
    const qaCount = document.getElementById('qaCount');
    const stagesList = document.getElementById('stagesList');
    const statusMsg = document.getElementById('statusMsg');
    const feedback = document.getElementById('feedback');
    const progressFill = document.getElementById('progressFill');
    const statsContainer = document.getElementById('statsContainer');
    const stageModal = document.getElementById('stageModal');
    const stageType = document.getElementById('stageType');
    const stageOptions = document.getElementById('stageOptions');

    // ========== الإعدادات ==========
    document.getElementById('voiceMethod').onchange = (e)=>{
      currentVoiceMethod = e.target.value;
    };
    
    document.getElementById('speechRate').oninput = (e)=>{
      speechRate = parseFloat(e.target.value);
      document.getElementById('rateValue').textContent = speechRate.toFixed(1) + 'x';
    };
    
    document.getElementById('delayTime').oninput = (e)=>{
      delayTime = parseFloat(e.target.value) * 1000;
      document.getElementById('delayValue').textContent = (delayTime/1000).toFixed(1) + 's';
    };
    
    document.getElementById('autoProgress').onchange = (e)=>{
      autoProgress = e.target.checked;
    };

    // ========== وظائف مساعدة ==========
    function delay(ms){return new Promise(r=>setTimeout(r,ms))}
    
    function normalizeText(s){
      if(!s) return '';
      s = s.toString().replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'');
      s = s.replace(/[\u2000-\u206F\u2E00-\u2E7F\`\~\!\@\#\$\%\^\&\*\(\)\-_\+=\[\]\\\{\}\|\;\:\"\'\<\>,\.\?\/]/g,'');
      return s.replace(/\s+/g,' ').trim().toLowerCase();
    }
    
    function showStatus(msg,type='ok'){
      feedback.style.display='block';
      feedback.className='status '+type;
      feedback.textContent=msg;
    }
    
    function hideStatus(){feedback.style.display='none'}

    // ========== النطق ==========
    function speak(text,rate=null){
      if(shouldStop) return Promise.resolve();
      const actualRate = rate || speechRate;
      
      if(currentVoiceMethod==='google'){
        return new Promise((resolve)=>{
          const audio = new Audio();
          audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ar&client=tw-ob&q=${encodeURIComponent(text)}`;
          audio.playbackRate = actualRate;
          audio.onended = ()=>resolve();
          audio.onerror = ()=>resolve();
          audio.play().catch(()=>resolve());
        });
      } else {
        return new Promise((resolve)=>{
          const synth = window.speechSynthesis;
          if(!synth){resolve();return}
          synth.cancel();
          const utter = new SpeechSynthesisUtterance(text);
          const voices = synth.getVoices();
          const arabicVoice = voices.find(v=>v.lang.startsWith('ar')||v.name.includes('Arabic'));
          if(arabicVoice){utter.voice=arabicVoice;utter.lang=arabicVoice.lang}
          else{utter.lang='ar-SA'}
          utter.rate = actualRate * 0.85;
          utter.onend=()=>resolve();
          utter.onerror=()=>resolve();
          synth.speak(utter);
        });
      }
    }

    document.getElementById('testVoice').onclick = async()=>{
      showStatus('🔊 اختبار الصوت...','ok');
      await speak('مرحباً، هذا اختبار للصوت العربي');
      showStatus('✅ تم الاختبار','success');
      setTimeout(hideStatus,2000);
    };

    // ========== التعرف على الصوت ==========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    function recognizeOnce(){
      return new Promise((res,rej)=>{
        if(!SpeechRecognition){rej(new Error('غير مدعوم'));return}
        const rec = new SpeechRecognition();
        rec.lang='ar-SA';rec.interimResults=false;
        rec.onresult=(ev)=>res(ev.results[0][0].transcript);
        rec.onerror=(e)=>rej(e);
        try{rec.start()}catch(e){rej(e)}
      });
    }

    // ========== إدارة الأسئلة ==========
    function renderQA(){
      qaCount.textContent = qa.length;
      if(qa.length===0){
        qaList.innerHTML='<li class="small">لا توجد أسئلة بعد</li>';
        return;
      }
      qaList.innerHTML = qa.map((item,idx)=>`
        <li class="list-item">
          <div style="flex:1">
            <div style="font-weight:600;margin-bottom:4px">${item.q}</div>
            <div class="small">✅ ${item.a}</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="playQA(${idx})">🔊</button>
            <button class="btn btn-danger" onclick="deleteQA(${idx})">🗑️</button>
          </div>
        </li>
      `).join('');
    }

    document.getElementById('addBtn').onclick=()=>{
      const q = qInput.value.trim();
      const a = aInput.value.trim();
      if(!q||!a){showStatus('⚠️ أكمل السؤال والإجابة','warning');return}
      qa.push({q,a});
      renderQA();
      qInput.value='';aInput.value='';qInput.focus();
      showStatus('✅ تم الإضافة','success');
      setTimeout(hideStatus,2000);
    };

    aInput.onkeypress=(e)=>{if(e.key==='Enter')document.getElementById('addBtn').click()};

    window.playQA = async(idx)=>{
      await speak(qa[idx].q);
      await delay(delayTime);
      await speak(qa[idx].a);
    };

    window.deleteQA = (idx)=>{
      if(confirm('حذف السؤال؟')){
        qa.splice(idx,1);
        renderQA();
      }
    };

    // ========== إدارة المراحل ==========
    function renderStages(){
      stagesList.innerHTML = stages.filter(s=>s.enabled).map((stage,idx)=>{
        const icons = {
          listen:'🎧',repeat:'🔄',test:'🎤',reverse:'🔁',
          userRead:'📖',random:'🎲',quiz:'❓'
        };
        return `
          <div class="stage-card" data-id="${stage.id}">
            <div class="stage-header">
              <div class="stage-number">${idx+1}</div>
              <div class="stage-title">${icons[stage.type]} ${stage.name}</div>
              <div>
                <button class="btn btn-secondary" onclick="editStage(${stage.id})">✏️</button>
                <button class="btn btn-secondary" onclick="runSingleStage(${stage.id})">▶️</button>
                <button class="btn btn-danger" onclick="deleteStage(${stage.id})">🗑️</button>
              </div>
            </div>
            <div class="small">${getStageDescription(stage)}</div>
          </div>
        `;
      }).join('');
    }

    function getStageDescription(stage){
      const descriptions = {
        listen: 'يقرأ السؤال والإجابة مرة واحدة',
        repeat: `يكرر السؤال والإجابة ${stage.config.times || 3} مرات`,
        test: 'يسألك ويستمع لإجابتك بالميكروفون',
        reverse: 'يقرأ الإجابة أولاً ثم السؤال',
        userRead: 'أنت تقرأ السؤال والإجابة والتطبيق يستمع',
        random: 'يعرض الأسئلة بترتيب عشوائي',
        quiz: 'اختبار اختيارات متعددة'
      };
      return descriptions[stage.type] || 'مرحلة مخصصة';
    }

    window.editStage = (id)=>{
      editingStageId = id;
      const stage = stages.find(s=>s.id===id);
      document.getElementById('modalTitle').textContent = '✏️ تعديل المرحلة';
      document.getElementById('stageName').value = stage.name;
      document.getElementById('stageType').value = stage.type;
      updateStageOptions(stage.type, stage.config);
      stageModal.classList.add('show');
    };

    window.deleteStage = (id)=>{
      if(confirm('حذف هذه المرحلة؟')){
        const stage = stages.find(s=>s.id===id);
        stage.enabled = false;
        renderStages();
        showStatus('✅ تم حذف المرحلة','success');
        setTimeout(hideStatus,2000);
      }
    };

    window.runSingleStage = async(id)=>{
      if(isProcessing) return;
      if(qa.length===0){showStatus('⚠️ أضف أسئلة أولاً','warning');return}
      
      shouldStop = false;
      isProcessing = true;
      const stage = stages.find(s=>s.id===id);
      
      document.querySelectorAll('.stage-card').forEach(card=>{
        card.classList.remove('active');
        if(parseInt(card.dataset.id)===id) card.classList.add('active');
      });
      
      await executeStage(stage);
      
      document.querySelectorAll('.stage-card').forEach(card=>{
        if(parseInt(card.dataset.id)===id) card.classList.add('completed');
      });
      
      isProcessing = false;
    };

    // ========== Modal ==========
    document.getElementById('addStageBtn').onclick = ()=>{
      editingStageId = null;
      document.getElementById('modalTitle').textContent = '➕ إضافة مرحلة جديدة';
      document.getElementById('stageName').value = '';
      document.getElementById('stageType').value = 'listen';
      updateStageOptions('listen');
      stageModal.classList.add('show');
    };

    document.getElementById('closeModal').onclick = ()=>{
      stageModal.classList.remove('show');
    };

    document.getElementById('cancelStageBtn').onclick = ()=>{
      stageModal.classList.remove('show');
    };

    document.getElementById('stageType').onchange = (e)=>{
      updateStageOptions(e.target.value);
    };

    function updateStageOptions(type, config={}){
      let html = '';
      
      if(type === 'repeat'){
        html = `
          <div style="margin-bottom:16px">
            <label class="setting-label">🔢 عدد مرات التكرار: <span id="timesValue">${config.times||3}</span></label>
            <input type="range" id="repeatTimes" min="1" max="10" step="1" value="${config.times||3}">
          </div>
        `;
      } else if(type === 'test' || type === 'userRead'){
        html = `
          <div style="margin-bottom:16px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="showCorrectAnswer" ${config.showCorrectAnswer?'checked':''}>
              <span>إظهار الإجابة الصحيحة عند الخطأ</span>
            </label>
          </div>
        `;
      } else if(type === 'quiz'){
        html = `
          <div style="margin-bottom:16px">
            <label class="setting-label">🔢 عدد الخيارات: <span id="optionsValue">${config.numOptions||4}</span></label>
            <input type="range" id="numOptions" min="2" max="6" step="1" value="${config.numOptions||4}">
          </div>
        `;
      }
      
      stageOptions.innerHTML = html;
      
      if(type === 'repeat'){
        document.getElementById('repeatTimes').oninput = (e)=>{
          document.getElementById('timesValue').textContent = e.target.value;
        };
      } else if(type === 'quiz'){
        document.getElementById('numOptions').oninput = (e)=>{
          document.getElementById('optionsValue').textContent = e.target.value;
        };
      }
    }

    document.getElementById('saveStageBtn').onclick = ()=>{
      const name = document.getElementById('stageName').value.trim();
      const type = document.getElementById('stageType').value;
      
      if(!name){showStatus('⚠️ أدخل اسم المرحلة','warning');return}
      
      const config = {};
      
      if(type === 'repeat'){
        config.times = parseInt(document.getElementById('repeatTimes').value);
      } else if(type === 'test' || type === 'userRead'){
        config.showCorrectAnswer = document.getElementById('showCorrectAnswer')?.checked || false;
      } else if(type === 'quiz'){
        config.numOptions = parseInt(document.getElementById('numOptions').value);
      }
      
      if(editingStageId){
        const stage = stages.find(s=>s.id===editingStageId);
        stage.name = name;
        stage.type = type;
        stage.config = config;
      } else {
        const newId = Math.max(...stages.map(s=>s.id), 0) + 1;
        stages.push({id:newId, name, type, config, enabled:true});
      }
      
      renderStages();
      stageModal.classList.remove('show');
      showStatus('✅ تم حفظ المرحلة','success');
      setTimeout(hideStatus,2000);
    };

    // ========== تنفيذ المراحل ==========
    async function executeStage(stage){
      statusMsg.textContent = `▶️ ${stage.name}`;
      showStatus(`🎯 ${stage.name}...`,'ok');
      
      let items = [...qa];
      if(stage.type === 'random'){
        items = items.sort(()=>Math.random()-0.5);
      }
      
      if(stage.type === 'listen'){
        await executeListen(items);
      } else if(stage.type === 'repeat'){
        await executeRepeat(items, stage.config.times || 3);
      } else if(stage.type === 'test'){
        await executeTest(items, stage.config);
      } else if(stage.type === 'reverse'){
        await executeReverse(items);
      } else if(stage.type === 'userRead'){
        await executeUserRead(items, stage.config);
      } else if(stage.type === 'quiz'){
        await executeQuiz(items, stage.config);
      }
      
      if(!shouldStop){
        showStatus(`✅ انتهت ${stage.name}`,'success');
      }
    }

    async function executeListen(items){
      for(let i=0; i<items.length && !shouldStop; i++){
        statusMsg.textContent = `🎧 سؤال ${i+1} من ${items.length}`;
        await speak('السؤال ' + (i+1));
        await delay(delayTime*0.4);
        await speak(items[i].q);
        await delay(delayTime*0.6);
        await speak('الإجابة');
        await delay(delayTime*0.4);
        await speak(items[i].a);
        await delay(delayTime);
      }
    }

    async function executeRepeat(items, times){
      for(let i=0; i<items.length && !shouldStop; i++){
        statusMsg.textContent = `🔄 سؤال ${i+1} من ${items.length}`;
        for(let r=0; r<times && !shouldStop; r++){
          await speak(items[i].q);
          await delay(delayTime*0.6);
          await speak(items[i].a);
          await delay(delayTime*0.8);
        }
      }
    }

    async function executeTest(items, config){
      if(!SpeechRecognition){
        showStatus('❌ التعرف على الصوت غير مدعوم','bad');
        return;
      }
      
      let correct = 0;
      for(let i=0; i<items.length && !shouldStop; i++){
        statusMsg.textContent = `🎤 سؤال ${i+1} من ${items.length}`;
        await speak(items[i].q);
        await delay(delayTime*0.5);
        showStatus(`🎤 أجب على السؤال ${i+1}...`,'ok');
        
        try{
          const userAnswer = await recognizeOnce();
          const isCorrect = normalizeText(userAnswer) === normalizeText(items[i].a);
          
          if(isCorrect){
            correct++;
            showStatus(`✅ (${i+1}) صحيح!`,'success');
            await speak('صحيح');
          } else {
            showStatus(`❌ (${i+1}) خاطئ: قلت "${userAnswer}"${config.showCorrectAnswer?' | الصواب: '+items[i].a:''}`,'bad');
            await speak('خاطئ');
            if(config.showCorrectAnswer){
              await delay(delayTime*0.4);
              await speak('الإجابة الصحيحة');
              await delay(delayTime*0.3);
              await speak(items[i].a);
            }
          }
          await delay(delayTime);
        }catch(e){
          showStatus('⚠️ لم يتم سماع الإجابة','warning');
          await delay(delayTime*1.5);
        }
      }
      
      const perc = Math.round(correct/items.length*100);
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('totalCount').textContent = items.length;
      document.getElementById('percentageCount').textContent = perc+'%';
      statsContainer.style.display = 'flex';
    }

    async function executeReverse(items){
      for(let i=0; i<items.length && !shouldStop; i++){
        statusMsg.textContent = `🔁 سؤال ${i+1} من ${items.length}`;
        await speak('الإجابة');
        await delay(delayTime*0.4);
        await speak(items[i].a);
        await delay(delayTime*0.8);
        await speak('السؤال');
        await delay(delayTime*0.4);
        await speak(items[i].q);
        await delay(delayTime);
      }
    }

    async function executeUserRead(items, config){
      if(!SpeechRecognition){
        showStatus('❌ التعرف على الصوت غير مدعوم','bad');
        return;
      }
      
      for(let i=0; i<items.length && !shouldStop; i++){
        statusMsg.textContent = `📖 سؤال ${i+1} من ${items.length}`;
        showStatus(`📖 اقرأ السؤال ${i+1} بصوت واضح...`,'ok');
        
        try{
          const userQ = await recognizeOnce();
          await delay(delayTime*0.5);
          showStatus(`📖 الآن اقرأ الإجابة...`,'ok');
          const userA = await recognizeOnce();
          
          const qCorrect = normalizeText(userQ) === normalizeText(items[i].q);
          const aCorrect = normalizeText(userA) === normalizeText(items[i].a);
          
          if(qCorrect && aCorrect){
            showStatus(`✅ (${i+1}) قراءة صحيحة!`,'success');
            await speak('ممتاز');
          } else {
            showStatus(`⚠️ (${i+1}) تحقق من القراءة`,'warning');
            if(!qCorrect && config.showCorrectAnswer){
              await speak('السؤال الصحيح');
              await delay(delayTime*0.3);
              await speak(items[i].q);
            }
            if(!aCorrect && config.showCorrectAnswer){
              await speak('الإجابة الصحيحة');
              await delay(delayTime*0.3);
              await speak(items[i].a);
            }
          }
          await delay(delayTime);
        }catch(e){
          showStatus('⚠️ لم يتم سماع القراءة','warning');
          await delay(delayTime*1.5);
        }
      }
    }

    async function executeQuiz(items, config){
      const numOptions = config.numOptions || 4;
      let correct = 0;
      
      for(let i=0; i<items.length && !shouldStop; i++){
        statusMsg.textContent = `❓ سؤال ${i+1} من ${items.length}`;
        
        // إنشاء خيارات
        const options = [items[i].a];
        const otherAnswers = items.filter((_,idx)=>idx!==i).map(item=>item.a);
        while(options.length < numOptions && otherAnswers.length > 0){
          const randomIdx = Math.floor(Math.random() * otherAnswers.length);
          options.push(otherAnswers.splice(randomIdx, 1)[0]);
        }
        options.sort(()=>Math.random()-0.5);
        const correctIdx = options.indexOf(items[i].a) + 1;
        
        // قراءة السؤال
        await speak(items[i].q);
        await delay(delayTime*0.6);
        
        // قراءة الخيارات
        for(let j=0; j<options.length; j++){
          await speak(`الخيار ${j+1}`);
          await delay(delayTime*0.3);
          await speak(options[j]);
          await delay(delayTime*0.5);
        }
        
        showStatus(`❓ اختر رقم الخيار الصحيح (1-${numOptions})...`,'ok');
        
        try{
          const userAnswer = await recognizeOnce();
          const userNum = parseInt(userAnswer.match(/\d+/)?.[0] || '0');
          
          if(userNum === correctIdx){
            correct++;
            showStatus(`✅ (${i+1}) إجابة صحيحة!`,'success');
            await speak('صحيح');
          } else {
            showStatus(`❌ (${i+1}) خاطئ | الصواب: ${correctIdx}`,'bad');
            await speak(`خاطئ الإجابة الصحيحة الخيار ${correctIdx}`);
          }
          await delay(delayTime);
        }catch(e){
          showStatus('⚠️ لم يتم سماع الإجابة','warning');
          await delay(delayTime*1.5);
        }
      }
      
      const perc = Math.round(correct/items.length*100);
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('totalCount').textContent = items.length;
      document.getElementById('percentageCount').textContent = perc+'%';
      statsContainer.style.display = 'flex';
    }

    // ========== تشغيل جميع المراحل ==========
    document.getElementById('startAll').onclick = async()=>{
      if(isProcessing) return;
      if(qa.length===0){showStatus('⚠️ أضف أسئلة أولاً','warning');return}
      
      const enabledStages = stages.filter(s=>s.enabled);
      if(!confirm(`🚀 بدء ${enabledStages.length} مراحل؟`)) return;
      
      shouldStop = false;
      isProcessing = true;
      statsContainer.style.display = 'none';
      
      for(let i=0; i<enabledStages.length && !shouldStop; i++){
        const stage = enabledStages[i];
        progressFill.style.width = ((i/enabledStages.length)*100)+'%';
        
        document.querySelectorAll('.stage-card').forEach(card=>{
          card.classList.remove('active');
          if(parseInt(card.dataset.id)===stage.id) card.classList.add('active');
        });
        
        await executeStage(stage);
        
        document.querySelectorAll('.stage-card').forEach(card=>{
          if(parseInt(card.dataset.id)===stage.id){
            card.classList.remove('active');
            card.classList.add('completed');
          }
        });
        
        if(autoProgress && i < enabledStages.length-1 && !shouldStop){
          await delay(3000);
          showStatus('⏩ الانتقال للمرحلة التالية...','ok');
          await delay(2000);
        }
      }
      
      progressFill.style.width = '100%';
      if(!shouldStop){
        showStatus('🎊 تم إكمال جميع المراحل!','success');
        await speak('تهانينا! لقد أكملت جميع المراحل');
      }
      
      isProcessing = false;
    };

    document.getElementById('stopAll').onclick = ()=>{
      shouldStop = true;
      isProcessing = false;
      statusMsg.textContent = '⏹️ تم الإيقاف';
      showStatus('⏹️ توقف','warning');
      if(window.speechSynthesis) window.speechSynthesis.cancel();
    };

    // ========== التصدير والاستيراد ==========
    document.getElementById('exportData').onclick = ()=>{
      const data = {qa, stages};
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'تسميع-'+new Date().toISOString().split('T')[0]+'.json';
      a.click();
      URL.revokeObjectURL(url);
      showStatus('✅ تم التصدير','success');
      setTimeout(hideStatus,2000);
    };

    document.getElementById('importData').onclick = ()=>{
      document.getElementById('fileInput').click();
    };

    document.getElementById('fileInput').onchange = (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const data = JSON.parse(ev.target.result);
          if(data.qa) qa = data.qa;
          if(data.stages) stages = data.stages;
          renderQA();
          renderStages();
          showStatus('✅ تم الاستيراد','success');
        }catch(err){
          showStatus('❌ ملف غير صالح','bad');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    };

    document.getElementById('clearAll').onclick = ()=>{
      if(confirm('⚠️ حذف كل شيء؟')){
        qa = [];
        stages = stages.map(s=>({...s,enabled:false}));
        renderQA();
        renderStages();
        statsContainer.style.display = 'none';
        showStatus('✅ تم المسح','success');
      }
    };

    // ========== التهيئة ==========
    renderQA();
    renderStages();
    
    setTimeout(()=>{
      speak('مرحباً بك في تطبيق التسميع الذكي');
    }, 1000);
  </script>
</body>
</html>
